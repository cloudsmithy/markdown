## **8. é”™è¯¯å¤„ç†ä¸æ—¥å¿—**

åœ¨æ„å»º RESTful API æ—¶ï¼Œé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ˜¯ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§çš„é‡è¦ç¯èŠ‚ã€‚è‰¯å¥½çš„é”™è¯¯å¤„ç†å¯ä»¥æé«˜ç”¨æˆ·ä½“éªŒï¼Œè€Œæ—¥å¿—è®°å½•åˆ™æœ‰åŠ©äºå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰é”™è¯¯å¤„ç†ã€è¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”ã€ä½¿ç”¨ Flask-Logging è®°å½•æ—¥å¿—ä»¥åŠé›†æˆ Sentry è¿›è¡Œé”™è¯¯è¿½è¸ªã€‚

---

### **8.1 è‡ªå®šä¹‰é”™è¯¯å¤„ç†**

#### **8.1.1 ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰é”™è¯¯å¤„ç†ï¼Ÿ**
è‡ªå®šä¹‰é”™è¯¯å¤„ç†æ˜¯æŒ‡æ•è·åº”ç”¨ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå¹¶è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ Flask é”™è¯¯é¡µé¢ã€‚

#### **8.1.2 ç¤ºä¾‹ï¼šè‡ªå®šä¹‰é”™è¯¯å¤„ç†**
```python
from flask import jsonify

@app.errorhandler(404)
def not_found(error):
    return jsonify({'message': 'Resource not found'}), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({'message': 'Internal server error'}), 500
```

- **@app.errorhandler**ï¼šæ•è·æŒ‡å®šçŠ¶æ€ç çš„å¼‚å¸¸ã€‚
- **jsonify**ï¼šè¿”å› JSON æ ¼å¼çš„é”™è¯¯ä¿¡æ¯ã€‚

#### **8.1.3 æ•è·è‡ªå®šä¹‰å¼‚å¸¸**
å¯ä»¥å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸ï¼Œå¹¶æ•è·å®ƒä»¬ï¼š
```python
class CustomError(Exception):
    pass

@app.errorhandler(CustomError)
def handle_custom_error(error):
    return jsonify({'message': 'Custom error occurred'}), 400

@app.route('/custom-error')
def custom_error():
    raise CustomError('Something went wrong')
```

---

### **8.2 è¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”**

#### **8.2.1 ä»€ä¹ˆæ˜¯æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”ï¼Ÿ**
æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”æ˜¯æŒ‡æ‰€æœ‰é”™è¯¯éƒ½éµå¾ªç›¸åŒçš„æ ¼å¼ï¼Œä¾¿äºå®¢æˆ·ç«¯è§£æå’Œå¤„ç†ã€‚

#### **8.2.2 ç¤ºä¾‹ï¼šæ ‡å‡†åŒ–çš„é”™è¯¯å“åº”**
å®šä¹‰ä¸€ä¸ªé€šç”¨çš„é”™è¯¯å“åº”æ ¼å¼ï¼š
```python
def error_response(message, status_code):
    return jsonify({
        'success': False,
        'error': {
            'code': status_code,
            'message': message
        }
    }), status_code
```

åœ¨é”™è¯¯å¤„ç†ä¸­ä½¿ç”¨ï¼š
```python
@app.errorhandler(404)
def not_found(error):
    return error_response('Resource not found', 404)

@app.errorhandler(500)
def internal_error(error):
    return error_response('Internal server error', 500)
```

#### **8.2.3 è¿”å›ç¤ºä¾‹**
- **404 é”™è¯¯**ï¼š
  ```json
  {
      "success": false,
      "error": {
          "code": 404,
          "message": "Resource not found"
      }
  }
  ```

- **500 é”™è¯¯**ï¼š
  ```json
  {
      "success": false,
      "error": {
          "code": 500,
          "message": "Internal server error"
      }
  }
  ```

---

### **8.3 ä½¿ç”¨ Flask-Logging è®°å½•æ—¥å¿—**

#### **8.3.1 ä»€ä¹ˆæ˜¯ Flask-Loggingï¼Ÿ**
Flask-Logging æ˜¯ Flask çš„æ—¥å¿—è®°å½•æ‰©å±•ï¼Œç”¨äºè®°å½•åº”ç”¨çš„è¿è¡Œæ—¥å¿—ã€‚

#### **8.3.2 é…ç½®æ—¥å¿—è®°å½•**
åœ¨ `app.py` ä¸­é…ç½®æ—¥å¿—è®°å½•ï¼š
```python
import logging
from logging.handlers import RotatingFileHandler

# é…ç½®æ—¥å¿—è®°å½•
handler = RotatingFileHandler('app.log', maxBytes=10000, backupCount=3)
handler.setLevel(logging.INFO)
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
handler.setFormatter(formatter)
app.logger.addHandler(handler)
app.logger.setLevel(logging.INFO)
```

- **RotatingFileHandler**ï¼šå°†æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼Œå¹¶æ”¯æŒæ–‡ä»¶è½®æ¢ã€‚
- **maxBytes**ï¼šå•ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚
- **backupCount**ï¼šä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ã€‚

#### **8.3.3 è®°å½•æ—¥å¿—**
åœ¨ä»£ç ä¸­ä½¿ç”¨ `app.logger` è®°å½•æ—¥å¿—ï¼š
```python
@app.route('/log')
def log():
    app.logger.info('This is an info log')
    app.logger.error('This is an error log')
    return 'Logged successfully'
```

#### **8.3.4 æ—¥å¿—æ–‡ä»¶ç¤ºä¾‹**
æ—¥å¿—æ–‡ä»¶ `app.log` çš„å†…å®¹ï¼š
```
2023-10-01 12:00:00,000 - app - INFO - This is an info log
2023-10-01 12:00:01,000 - app - ERROR - This is an error log
```

---

### **8.4 é›†æˆ Sentry è¿›è¡Œé”™è¯¯è¿½è¸ª**

#### **8.4.1 ä»€ä¹ˆæ˜¯ Sentryï¼Ÿ**
Sentry æ˜¯ä¸€ä¸ªå¼€æºçš„é”™è¯¯è¿½è¸ªå·¥å…·ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…å®æ—¶ç›‘æ§å’Œä¿®å¤åº”ç”¨ä¸­çš„é”™è¯¯ã€‚

#### **8.4.2 å®‰è£… Sentry**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Sentryï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install sentry-sdk[flask]
```

#### **8.4.3 é…ç½® Sentry**
åœ¨ `app.py` ä¸­é…ç½® Sentryï¼š
```python
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration

# åˆå§‹åŒ– Sentry
sentry_sdk.init(
    dsn='your-sentry-dsn',  # æ›¿æ¢ä¸ºä½ çš„ Sentry DSN
    integrations=[FlaskIntegration()],
    traces_sample_rate=1.0
)
```

- **dsn**ï¼šSentry é¡¹ç›®çš„ DSNï¼ˆæ•°æ®æºåç§°ï¼‰ã€‚
- **FlaskIntegration**ï¼šé›†æˆ Flask åº”ç”¨ã€‚
- **traces_sample_rate**ï¼šé‡‡æ ·ç‡ï¼ˆ0.0 åˆ° 1.0ï¼‰ã€‚

#### **8.4.4 æµ‹è¯• Sentry**
åœ¨ä»£ç ä¸­è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼ŒSentry ä¼šè‡ªåŠ¨æ•è·å¹¶è®°å½•ï¼š
```python
@app.route('/sentry-error')
def sentry_error():
    division_by_zero = 1 / 0  # è§¦å‘é”™è¯¯
    return 'This will not be reached'
```

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•çš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, jsonify
import logging
from logging.handlers import RotatingFileHandler
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration

app = Flask(__name__)

# é…ç½®æ—¥å¿—è®°å½•
handler = RotatingFileHandler('app.log', maxBytes=10000, backupCount=3)
handler.setLevel(logging.INFO)
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
handler.setFormatter(formatter)
app.logger.addHandler(handler)
app.logger.setLevel(logging.INFO)

# é…ç½® Sentry
sentry_sdk.init(
    dsn='your-sentry-dsn',
    integrations=[FlaskIntegration()],
    traces_sample_rate=1.0
)

# è‡ªå®šä¹‰é”™è¯¯å¤„ç†
@app.errorhandler(404)
def not_found(error):
    app.logger.error('Resource not found')
    return jsonify({'message': 'Resource not found'}), 404

@app.errorhandler(500)
def internal_error(error):
    app.logger.error('Internal server error')
    return jsonify({'message': 'Internal server error'}), 500

# æµ‹è¯•è·¯ç”±
@app.route('/log')
def log():
    app.logger.info('This is an info log')
    app.logger.error('This is an error log')
    return 'Logged successfully'

@app.route('/sentry-error')
def sentry_error():
    division_by_zero = 1 / 0  # è§¦å‘é”™è¯¯
    return 'This will not be reached'

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•è‡ªå®šä¹‰é”™è¯¯å¤„ç†å¹¶è¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”ã€‚
2. å¦‚ä½•ä½¿ç”¨ Flask-Logging è®°å½•æ—¥å¿—ã€‚
3. å¦‚ä½•é›†æˆ Sentry è¿›è¡Œé”™è¯¯è¿½è¸ªã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **9. é«˜çº§åŠŸèƒ½**ï¼Œå­¦ä¹ å¦‚ä½•å®ç°åˆ†é¡µã€ç¼“å­˜å’Œæ–‡ä»¶ä¸Šä¼ ç­‰é«˜çº§åŠŸèƒ½ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
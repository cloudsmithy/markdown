## **10. API æ–‡æ¡£ä¸æµ‹è¯•**

åœ¨æ„å»º RESTful API æ—¶ï¼Œè‰¯å¥½çš„æ–‡æ¡£å’Œå…¨é¢çš„æµ‹è¯•æ˜¯ç¡®ä¿ API è´¨é‡å’Œå¯ç»´æŠ¤æ€§çš„å…³é”®ã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Flasgger è‡ªåŠ¨ç”Ÿæˆ Swagger æ–‡æ¡£ã€ç¼–å†™å•å…ƒæµ‹è¯•ä»¥åŠä½¿ç”¨ Postman æµ‹è¯• APIã€‚

---

### **10.1 ä½¿ç”¨ Flasgger è‡ªåŠ¨ç”Ÿæˆ Swagger æ–‡æ¡£**

#### **10.1.1 ä»€ä¹ˆæ˜¯ Swaggerï¼Ÿ**
Swagger æ˜¯ä¸€ç§ç”¨äºæè¿°å’Œè®°å½• RESTful API çš„å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ä¸ªäº¤äº’å¼çš„ UIï¼Œæ–¹ä¾¿å¼€å‘è€…æŸ¥çœ‹å’Œæµ‹è¯• APIã€‚

#### **10.1.2 å®‰è£… Flasgger**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flasggerï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install flasgger
```

#### **10.1.3 é…ç½® Flasgger**
åœ¨ `app.py` ä¸­é…ç½® Flasggerï¼š
```python
from flasgger import Swagger

app.config['SWAGGER'] = {
    'title': 'My API',
    'uiversion': 3
}
swagger = Swagger(app)
```

#### **10.1.4 ç¼–å†™ API æ–‡æ¡£**
åœ¨è§†å›¾å‡½æ•°ä¸­ä½¿ç”¨ Docstring å®šä¹‰ API æ–‡æ¡£ï¼š
```python
@app.route('/hello', methods=['GET'])
def hello():
    """
    A simple greeting endpoint.
    ---
    responses:
      200:
        description: A greeting message
    """
    return 'Hello, World!'
```

#### **10.1.5 è®¿é—® Swagger UI**
å¯åŠ¨åº”ç”¨åï¼Œè®¿é—® `http://127.0.0.1:5000/apidocs`ï¼Œå³å¯çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ Swagger æ–‡æ¡£ã€‚

---

### **10.2 ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆFlask-Testingã€pytestï¼‰**

#### **10.2.1 ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•ï¼Ÿ**
å•å…ƒæµ‹è¯•æ˜¯å¯¹ä»£ç çš„æœ€å°å•å…ƒï¼ˆå¦‚å‡½æ•°ã€æ–¹æ³•ï¼‰è¿›è¡Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿å…¶è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚

#### **10.2.2 å®‰è£… Flask-Testing å’Œ pytest**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flask-Testing å’Œ pytestï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install Flask-Testing pytest
```

#### **10.2.3 ç¼–å†™å•å…ƒæµ‹è¯•**
- **ç¤ºä¾‹ï¼šæµ‹è¯•ç”¨æˆ·æ³¨å†Œ**
  ```python
  import unittest
  from app import app, db, User

  class UserTestCase(unittest.TestCase):
      def setUp(self):
          app.config['TESTING'] = True
          app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
          self.app = app.test_client()
          db.create_all()

      def tearDown(self):
          db.session.remove()
          db.drop_all()

      def test_register(self):
          response = self.app.post('/register', json={
              'username': 'Alice',
              'password': 'password',
              'email': 'alice@example.com'
          })
          self.assertEqual(response.status_code, 201)
          self.assertIn('User registered successfully', response.get_data(as_text=True))
  ```

- **setUp**ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå‰åˆå§‹åŒ–ç¯å¢ƒã€‚
- **tearDown**ï¼šåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œåæ¸…ç†ç¯å¢ƒã€‚
- **test_register**ï¼šæµ‹è¯•ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ã€‚

#### **10.2.4 è¿è¡Œå•å…ƒæµ‹è¯•**
åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼š
```bash
pytest
```

---

### **10.3 ä½¿ç”¨ Postman æµ‹è¯• API**

#### **10.3.1 ä»€ä¹ˆæ˜¯ Postmanï¼Ÿ**
Postman æ˜¯ä¸€ä¸ªæµè¡Œçš„ API æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒå‘é€ HTTP è¯·æ±‚ã€æŸ¥çœ‹å“åº”å’Œè°ƒè¯• APIã€‚

#### **10.3.2 ä½¿ç”¨ Postman æµ‹è¯• API**
1. **ä¸‹è½½å¹¶å®‰è£… Postman**ï¼š
   - è®¿é—® [Postman å®˜æ–¹ç½‘ç«™](https://www.postman.com/downloads/)ï¼Œä¸‹è½½å¹¶å®‰è£… Postmanã€‚

2. **åˆ›å»ºè¯·æ±‚**ï¼š
   - æ‰“å¼€ Postmanï¼Œç‚¹å‡» `New` -> `Request`ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è¯·æ±‚ã€‚
   - è¾“å…¥è¯·æ±‚ URLï¼ˆå¦‚ `http://127.0.0.1:5000/register`ï¼‰ã€‚
   - é€‰æ‹©è¯·æ±‚æ–¹æ³•ï¼ˆå¦‚ `POST`ï¼‰ã€‚

3. **è®¾ç½®è¯·æ±‚ä½“**ï¼š
   - é€‰æ‹© `Body` -> `raw`ï¼Œå¹¶é€‰æ‹© `JSON` æ ¼å¼ã€‚
   - è¾“å…¥ JSON æ•°æ®ï¼š
     ```json
     {
         "username": "Alice",
         "password": "password",
         "email": "alice@example.com"
     }
     ```

4. **å‘é€è¯·æ±‚**ï¼š
   - ç‚¹å‡» `Send` æŒ‰é’®ï¼ŒæŸ¥çœ‹å“åº”ç»“æœã€‚

5. **ä¿å­˜è¯·æ±‚**ï¼š
   - ç‚¹å‡» `Save` æŒ‰é’®ï¼Œå°†è¯·æ±‚ä¿å­˜åˆ°é›†åˆä¸­ï¼Œæ–¹ä¾¿åç»­æµ‹è¯•ã€‚

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆ API æ–‡æ¡£ã€å•å…ƒæµ‹è¯•å’Œ Postman æµ‹è¯•çš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flasgger import Swagger

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///mydatabase.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SWAGGER'] = {
    'title': 'My API',
    'uiversion': 3
}

db = SQLAlchemy(app)
swagger = Swagger(app)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    password = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)

@app.route('/register', methods=['POST'])
def register():
    """
    Register a new user.
    ---
    parameters:
      - name: body
        in: body
        required: true
        schema:
          type: object
          properties:
            username:
              type: string
            password:
              type: string
            email:
              type: string
    responses:
      201:
        description: User registered successfully
      400:
        description: Username or email already exists
    """
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')
    email = data.get('email')

    if User.query.filter_by(username=username).first():
        return jsonify({'message': 'Username already exists'}), 400

    new_user = User(username=username, password=password, email=email)
    db.session.add(new_user)
    db.session.commit()

    return jsonify({'message': 'User registered successfully'}), 201

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•ä½¿ç”¨ Flasgger è‡ªåŠ¨ç”Ÿæˆ Swagger æ–‡æ¡£ã€‚
2. å¦‚ä½•ç¼–å†™å•å…ƒæµ‹è¯•å¹¶ä½¿ç”¨ pytest è¿è¡Œæµ‹è¯•ã€‚
3. å¦‚ä½•ä½¿ç”¨ Postman æµ‹è¯• APIã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **11. éƒ¨ç½²ä¸ä¼˜åŒ–**ï¼Œå­¦ä¹ å¦‚ä½•å°† Flask åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå¹¶è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
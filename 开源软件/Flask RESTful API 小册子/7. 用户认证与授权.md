## **7. ç”¨æˆ·è®¤è¯ä¸æˆæƒ**

åœ¨æ„å»º RESTful API æ—¶ï¼Œç”¨æˆ·è®¤è¯å’Œæˆæƒæ˜¯ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§çš„é‡è¦ç¯èŠ‚ã€‚**JWTï¼ˆJSON Web Tokenï¼‰** æ˜¯ä¸€ç§æµè¡Œçš„è®¤è¯æœºåˆ¶ï¼Œå®ƒé€šè¿‡åŠ å¯†çš„ Token æ¥éªŒè¯ç”¨æˆ·èº«ä»½ã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ **Flask-JWT-Extended** å®ç° JWT è®¤è¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿æŠ¤è·¯ç”±ä»¥åŠ Token åˆ·æ–°å’Œé»‘åå•åŠŸèƒ½ã€‚

---

### **7.1 ä½¿ç”¨ Flask-JWT-Extended å®ç° JWT è®¤è¯**

#### **7.1.1 ä»€ä¹ˆæ˜¯ JWTï¼Ÿ**
JWT æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚å®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
1. **Header**ï¼šåŒ…å« Token ç±»å‹å’ŒåŠ å¯†ç®—æ³•ã€‚
2. **Payload**ï¼šåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œå…¶ä»–æ•°æ®ã€‚
3. **Signature**ï¼šç”¨äºéªŒè¯ Token çš„å®Œæ•´æ€§ã€‚

JWT çš„ä¼˜ç‚¹æ˜¯ï¼š
- **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä¼šè¯ä¿¡æ¯ã€‚
- **è·¨åŸŸæ”¯æŒ**ï¼šé€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¾®æœåŠ¡æ¶æ„ã€‚

#### **7.1.2 å®‰è£… Flask-JWT-Extended**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flask-JWT-Extendedï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install Flask-JWT-Extended
```

#### **7.1.3 é…ç½® Flask-JWT-Extended**
åœ¨ `app.py` ä¸­é…ç½® Flask-JWT-Extendedï¼š
```python
from flask import Flask
from flask_jwt_extended import JWTManager

app = Flask(__name__)

# è®¾ç½® JWT å¯†é’¥
app.config['JWT_SECRET_KEY'] = 'your-secret-key'  # æ›¿æ¢ä¸ºå¼ºå¯†é’¥
app.config['JWT_ACCESS_TOKEN_EXPIRES'] = 3600  # Token æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰

# åˆå§‹åŒ– JWTManager
jwt = JWTManager(app)
```

- **JWT_SECRET_KEY**ï¼šç”¨äºç­¾åå’ŒéªŒè¯ Token çš„å¯†é’¥ã€‚
- **JWT_ACCESS_TOKEN_EXPIRES**ï¼šToken çš„æœ‰æ•ˆæœŸã€‚

---

### **7.2 ç”¨æˆ·æ³¨å†Œä¸ç™»å½•**

#### **7.2.1 ç”¨æˆ·æ³¨å†Œ**
ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ã€‚

- **ç¤ºä¾‹ï¼šç”¨æˆ·æ³¨å†Œè·¯ç”±**
  ```python
  from flask import request, jsonify
  from werkzeug.security import generate_password_hash

  @app.route('/register', methods=['POST'])
  def register():
      data = request.get_json()
      username = data.get('username')
      password = data.get('password')
      email = data.get('email')

      if User.query.filter_by(username=username).first():
          return jsonify({'message': 'Username already exists'}), 400

      new_user = User(
          username=username,
          password=generate_password_hash(password),  # åŠ å¯†å¯†ç 
          email=email
      )
      db.session.add(new_user)
      db.session.commit()

      return jsonify({'message': 'User registered successfully'}), 201
  ```

#### **7.2.2 ç”¨æˆ·ç™»å½•**
ç”¨æˆ·ç™»å½•æ—¶ï¼ŒéªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼Œå¹¶ç”Ÿæˆ JWTã€‚

- **ç¤ºä¾‹ï¼šç”¨æˆ·ç™»å½•è·¯ç”±**
  ```python
  from flask_jwt_extended import create_access_token
  from werkzeug.security import check_password_hash

  @app.route('/login', methods=['POST'])
  def login():
      data = request.get_json()
      username = data.get('username')
      password = data.get('password')

      user = User.query.filter_by(username=username).first()
      if user and check_password_hash(user.password, password):
          access_token = create_access_token(identity=username)
          return jsonify(access_token=access_token), 200
      else:
          return jsonify({'message': 'Invalid credentials'}), 401
  ```

- **create_access_token**ï¼šç”Ÿæˆ JWTï¼Œ`identity` å‚æ•°ç”¨äºæ ‡è¯†ç”¨æˆ·ã€‚

---

### **7.3 ä¿æŠ¤è·¯ç”±ï¼ˆ@jwt_requiredï¼‰**

#### **7.3.1 ä»€ä¹ˆæ˜¯ä¿æŠ¤è·¯ç”±ï¼Ÿ**
ä¿æŠ¤è·¯ç”±æ˜¯æŒ‡åªæœ‰é€šè¿‡è®¤è¯çš„ç”¨æˆ·æ‰èƒ½è®¿é—®çš„è·¯ç”±ã€‚Flask-JWT-Extended æä¾›äº† `@jwt_required` è£…é¥°å™¨æ¥å®ç°è·¯ç”±ä¿æŠ¤ã€‚

#### **7.3.2 ç¤ºä¾‹ï¼šä¿æŠ¤è·¯ç”±**
```python
from flask_jwt_extended import jwt_required, get_jwt_identity

@app.route('/protected', methods=['GET'])
@jwt_required()
def protected():
    current_user = get_jwt_identity()  # è·å–å½“å‰ç”¨æˆ·
    return jsonify(logged_in_as=current_user), 200
```

- **@jwt_required**ï¼šç¡®ä¿åªæœ‰æºå¸¦æœ‰æ•ˆ Token çš„è¯·æ±‚æ‰èƒ½è®¿é—®è¯¥è·¯ç”±ã€‚
- **get_jwt_identity**ï¼šè·å– Token ä¸­çš„ç”¨æˆ·æ ‡è¯†ã€‚

#### **7.3.3 æµ‹è¯•ä¿æŠ¤è·¯ç”±**
1. ç™»å½•å¹¶è·å– Tokenï¼š
   ```bash
   curl -X POST -H "Content-Type: application/json" -d '{"username": "Alice", "password": "password"}' http://127.0.0.1:5000/login
   ```
   è¿”å›çš„ Tokenï¼š
   ```json
   {
       "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
   }
   ```

2. è®¿é—®ä¿æŠ¤è·¯ç”±ï¼š
   ```bash
   curl -H "Authorization: Bearer <access_token>" http://127.0.0.1:5000/protected
   ```
   è¿”å›çš„æ•°æ®ï¼š
   ```json
   {
       "logged_in_as": "Alice"
   }
   ```

---

### **7.4 Token åˆ·æ–°ä¸é»‘åå•**

#### **7.4.1 Token åˆ·æ–°**
JWT çš„æœ‰æ•ˆæœŸé€šå¸¸è¾ƒçŸ­ï¼Œä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥é€šè¿‡åˆ·æ–° Token æ¥å»¶é•¿ä¼šè¯ã€‚

- **ç¤ºä¾‹ï¼šåˆ·æ–° Token**
  ```python
  from flask_jwt_extended import create_refresh_token, jwt_refresh_token_required, get_jwt_identity

  @app.route('/refresh', methods=['POST'])
  @jwt_refresh_token_required
  def refresh():
      current_user = get_jwt_identity()
      new_access_token = create_access_token(identity=current_user)
      return jsonify(access_token=new_access_token), 200
  ```

- **jwt_refresh_token_required**ï¼šç¡®ä¿è¯·æ±‚æºå¸¦æœ‰æ•ˆçš„åˆ·æ–° Tokenã€‚
- **create_access_token**ï¼šç”Ÿæˆæ–°çš„è®¿é—® Tokenã€‚

#### **7.4.2 Token é»‘åå•**
ä¸ºäº†é˜²æ­¢ Token è¢«æ»¥ç”¨ï¼Œå¯ä»¥å°†å¤±æ•ˆçš„ Token åŠ å…¥é»‘åå•ã€‚

- **ç¤ºä¾‹ï¼šå®ç°é»‘åå•**
  ```python
  from flask_jwt_extended import get_raw_jwt

  blacklist = set()

  @jwt.token_in_blacklist_loader
  def check_if_token_in_blacklist(decrypted_token):
      jti = decrypted_token['jti']
      return jti in blacklist

  @app.route('/logout', methods=['DELETE'])
  @jwt_required()
  def logout():
      jti = get_raw_jwt()['jti']
      blacklist.add(jti)
      return jsonify({'message': 'Successfully logged out'}), 200
  ```

- **jwt.token_in_blacklist_loader**ï¼šæ£€æŸ¥ Token æ˜¯å¦åœ¨é»‘åå•ä¸­ã€‚
- **get_raw_jwt**ï¼šè·å–å½“å‰ Token çš„åŸå§‹æ•°æ®ã€‚

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆç”¨æˆ·è®¤è¯å’Œæˆæƒçš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_jwt_extended import (
    JWTManager, create_access_token, jwt_required,
    get_jwt_identity, jwt_refresh_token_required, get_raw_jwt
)
from werkzeug.security import generate_password_hash, check_password_hash

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///mydatabase.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['JWT_SECRET_KEY'] = 'your-secret-key'
app.config['JWT_ACCESS_TOKEN_EXPIRES'] = 3600

db = SQLAlchemy(app)
jwt = JWTManager(app)

blacklist = set()

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    password = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)

    def __repr__(self):
        return f'<User {self.username}>'

@jwt.token_in_blacklist_loader
def check_if_token_in_blacklist(decrypted_token):
    jti = decrypted_token['jti']
    return jti in blacklist

@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')
    email = data.get('email')

    if User.query.filter_by(username=username).first():
        return jsonify({'message': 'Username already exists'}), 400

    new_user = User(
        username=username,
        password=generate_password_hash(password),
        email=email
    )
    db.session.add(new_user)
    db.session.commit()

    return jsonify({'message': 'User registered successfully'}), 201

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

    user = User.query.filter_by(username=username).first()
    if user and check_password_hash(user.password, password):
        access_token = create_access_token(identity=username)
        refresh_token = create_refresh_token(identity=username)
        return jsonify(access_token=access_token, refresh_token=refresh_token), 200
    else:
        return jsonify({'message': 'Invalid credentials'}), 401

@app.route('/protected', methods=['GET'])
@jwt_required()
def protected():
    current_user = get_jwt_identity()
    return jsonify(logged_in_as=current_user), 200

@app.route('/refresh', methods=['POST'])
@jwt_refresh_token_required
def refresh():
    current_user = get_jwt_identity()
    new_access_token = create_access_token(identity=current_user)
    return jsonify(access_token=new_access_token), 200

@app.route('/logout', methods=['DELETE'])
@jwt_required()
def logout():
    jti = get_raw_jwt()['jti']
    blacklist.add(jti)
    return jsonify({'message': 'Successfully logged out'}), 200

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•ä½¿ç”¨ Flask-JWT-Extended å®ç° JWT è®¤è¯ã€‚
2. å¦‚ä½•å®ç°ç”¨æˆ·æ³¨å†Œå’Œç™»å½•åŠŸèƒ½ã€‚
3. å¦‚ä½•ä¿æŠ¤è·¯ç”±å¹¶éªŒè¯ç”¨æˆ·èº«ä»½ã€‚
4. å¦‚ä½•å®ç° Token åˆ·æ–°å’Œé»‘åå•åŠŸèƒ½ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **8. é”™è¯¯å¤„ç†ä¸æ—¥å¿—**ï¼Œå­¦ä¹ å¦‚ä½•å¤„ç†é”™è¯¯å’Œè®°å½•æ—¥å¿—ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
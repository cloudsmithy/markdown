## **5. æ•°æ®éªŒè¯ä¸åºåˆ—åŒ–**

åœ¨æ„å»º RESTful API æ—¶ï¼Œæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–æ˜¯éå¸¸é‡è¦çš„ç¯èŠ‚ã€‚æ•°æ®éªŒè¯ç¡®ä¿å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œè€Œåºåˆ—åŒ–åˆ™å°† Python å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼ï¼Œä¾¿äºä¼ è¾“å’Œè§£æã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ **Marshmallow** åº“æ¥å®ç°æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–ã€‚

---

### **5.1 ä½¿ç”¨ Marshmallow è¿›è¡Œæ•°æ®éªŒè¯**

#### **5.1.1 ä»€ä¹ˆæ˜¯ Marshmallowï¼Ÿ**
Marshmallow æ˜¯ä¸€ä¸ªç”¨äºæ•°æ®éªŒè¯ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ Python åº“ã€‚å®ƒå¯ä»¥å°†å¤æ‚çš„ Python å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼ï¼ŒåŒæ—¶éªŒè¯è¾“å…¥æ•°æ®çš„åˆæ³•æ€§ã€‚

#### **5.1.2 å®‰è£… Marshmallow**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Marshmallowï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install marshmallow
```

#### **5.1.3 å®šä¹‰ Schema**
Schema æ˜¯ Marshmallow çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç”¨äºå®šä¹‰æ•°æ®çš„ç»“æ„å’ŒéªŒè¯è§„åˆ™ã€‚

- **ç¤ºä¾‹ï¼šç”¨æˆ· Schema**
  ```python
  from marshmallow import Schema, fields

  class UserSchema(Schema):
      id = fields.Int(dump_only=True)  # åªç”¨äºåºåˆ—åŒ–
      name = fields.Str(required=True)  # å¿…å¡«å­—æ®µ
      age = fields.Int(required=True)  # å¿…å¡«å­—æ®µ
  ```

- **å­—æ®µç±»å‹**ï¼š
  - `fields.Str`ï¼šå­—ç¬¦ä¸²å­—æ®µã€‚
  - `fields.Int`ï¼šæ•´æ•°å­—æ®µã€‚
  - `fields.Float`ï¼šæµ®ç‚¹æ•°å­—æ®µã€‚
  - `fields.Bool`ï¼šå¸ƒå°”å­—æ®µã€‚
  - `fields.DateTime`ï¼šæ—¥æœŸæ—¶é—´å­—æ®µã€‚

- **å­—æ®µå‚æ•°**ï¼š
  - `required`ï¼šæ˜¯å¦ä¸ºå¿…å¡«å­—æ®µã€‚
  - `dump_only`ï¼šåªç”¨äºåºåˆ—åŒ–ï¼ˆè¾“å‡ºï¼‰ã€‚
  - `load_only`ï¼šåªç”¨äºååºåˆ—åŒ–ï¼ˆè¾“å…¥ï¼‰ã€‚

#### **5.1.4 ä½¿ç”¨ Schema éªŒè¯æ•°æ®**
é€šè¿‡ `load` æ–¹æ³•å¯ä»¥éªŒè¯è¾“å…¥æ•°æ®ï¼š
```python
from marshmallow import ValidationError

data = {'name': 'Alice', 'age': 25}
schema = UserSchema()

try:
    result = schema.load(data)
    print(result)  # è¾“å‡ºï¼š{'name': 'Alice', 'age': 25}
except ValidationError as err:
    print(err.messages)  # è¾“å‡ºé”™è¯¯ä¿¡æ¯
```

å¦‚æœæ•°æ®ä¸ç¬¦åˆè§„åˆ™ï¼Œ`load` æ–¹æ³•ä¼šæŠ›å‡º `ValidationError` å¼‚å¸¸ï¼Œå¹¶è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚

---

### **5.2 åºåˆ—åŒ–ä¸ååºåˆ—åŒ–**

#### **5.2.1 åºåˆ—åŒ–**
åºåˆ—åŒ–æ˜¯å°† Python å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼çš„è¿‡ç¨‹ã€‚

- **ç¤ºä¾‹ï¼šåºåˆ—åŒ–ç”¨æˆ·å¯¹è±¡**
  ```python
  user = {'id': 1, 'name': 'Alice', 'age': 25}
  schema = UserSchema()
  result = schema.dump(user)
  print(result)  # è¾“å‡ºï¼š{'id': 1, 'name': 'Alice', 'age': 25}
  ```

- **åºåˆ—åŒ–å¤šä¸ªå¯¹è±¡**ï¼š
  ```python
  users = [{'id': 1, 'name': 'Alice', 'age': 25}, {'id': 2, 'name': 'Bob', 'age': 30}]
  schema = UserSchema(many=True)
  result = schema.dump(users)
  print(result)  # è¾“å‡ºï¼š[{'id': 1, 'name': 'Alice', 'age': 25}, {'id': 2, 'name': 'Bob', 'age': 30}]
  ```

#### **5.2.2 ååºåˆ—åŒ–**
ååºåˆ—åŒ–æ˜¯å°† JSON æ•°æ®è½¬æ¢ä¸º Python å¯¹è±¡çš„è¿‡ç¨‹ã€‚

- **ç¤ºä¾‹ï¼šååºåˆ—åŒ–ç”¨æˆ·æ•°æ®**
  ```python
  data = {'name': 'Alice', 'age': 25}
  schema = UserSchema()
  result = schema.load(data)
  print(result)  # è¾“å‡ºï¼š{'name': 'Alice', 'age': 25}
  ```

- **å¤„ç†åµŒå¥—æ•°æ®**ï¼š
  ```python
  class AddressSchema(Schema):
      city = fields.Str(required=True)
      street = fields.Str(required=True)

  class UserSchema(Schema):
      name = fields.Str(required=True)
      age = fields.Int(required=True)
      address = fields.Nested(AddressSchema)

  data = {'name': 'Alice', 'age': 25, 'address': {'city': 'Shanghai', 'street': 'Main St'}}
  schema = UserSchema()
  result = schema.load(data)
  print(result)  # è¾“å‡ºï¼š{'name': 'Alice', 'age': 25, 'address': {'city': 'Shanghai', 'street': 'Main St'}}
  ```

---

### **5.3 è‡ªå®šä¹‰éªŒè¯è§„åˆ™**

#### **5.3.1 ä½¿ç”¨ `validates` è£…é¥°å™¨**
å¯ä»¥é€šè¿‡ `validates` è£…é¥°å™¨å®šä¹‰è‡ªå®šä¹‰éªŒè¯è§„åˆ™ã€‚

- **ç¤ºä¾‹ï¼šéªŒè¯å¹´é¾„å¿…é¡»å¤§äº 0**
  ```python
  from marshmallow import Schema, fields, validates, ValidationError

  class UserSchema(Schema):
      name = fields.Str(required=True)
      age = fields.Int(required=True)

      @validates('age')
      def validate_age(self, value):
          if value < 0:
              raise ValidationError('Age must be a positive number.')
  ```

- **æµ‹è¯•è‡ªå®šä¹‰éªŒè¯è§„åˆ™**ï¼š
  ```python
  data = {'name': 'Alice', 'age': -5}
  schema = UserSchema()

  try:
      result = schema.load(data)
  except ValidationError as err:
      print(err.messages)  # è¾“å‡ºï¼š{'age': ['Age must be a positive number.']}
  ```

#### **5.3.2 ä½¿ç”¨ `validates_schema` æ–¹æ³•**
`validates_schema` æ–¹æ³•å¯ä»¥ç”¨äºè·¨å­—æ®µçš„éªŒè¯ã€‚

- **ç¤ºä¾‹ï¼šéªŒè¯å¯†ç å’Œç¡®è®¤å¯†ç æ˜¯å¦ä¸€è‡´**
  ```python
  from marshmallow import Schema, fields, ValidationError

  class UserSchema(Schema):
      password = fields.Str(required=True)
      confirm_password = fields.Str(required=True)

      @validates_schema
      def validate_passwords(self, data, **kwargs):
          if data['password'] != data['confirm_password']:
              raise ValidationError('Passwords do not match', 'confirm_password')
  ```

- **æµ‹è¯•è·¨å­—æ®µéªŒè¯**ï¼š
  ```python
  data = {'password': '123456', 'confirm_password': '654321'}
  schema = UserSchema()

  try:
      result = schema.load(data)
  except ValidationError as err:
      print(err.messages)  # è¾“å‡ºï¼š{'confirm_password': ['Passwords do not match']}
  ```

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–çš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, request, jsonify
from marshmallow import Schema, fields, ValidationError

app = Flask(__name__)

class UserSchema(Schema):
    id = fields.Int(dump_only=True)
    name = fields.Str(required=True)
    age = fields.Int(required=True)

    @validates('age')
    def validate_age(self, value):
        if value < 0:
            raise ValidationError('Age must be a positive number.')

user_schema = UserSchema()

@app.route('/users', methods=['POST'])
def create_user():
    data = request.get_json()
    try:
        result = user_schema.load(data)
        return jsonify(result), 201
    except ValidationError as err:
        return jsonify(err.messages), 400

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•ä½¿ç”¨ Marshmallow è¿›è¡Œæ•°æ®éªŒè¯ã€‚
2. å¦‚ä½•å®ç°æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
3. å¦‚ä½•å®šä¹‰è‡ªå®šä¹‰éªŒè¯è§„åˆ™ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **6. æ•°æ®åº“é›†æˆ**ï¼Œå­¦ä¹ å¦‚ä½•ä½¿ç”¨ Flask-SQLAlchemy è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
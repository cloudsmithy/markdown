## **12. å®æˆ˜é¡¹ç›®**

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼Œç»¼åˆè¿ç”¨å‰é¢æ‰€å­¦çš„çŸ¥è¯†ã€‚è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªç®€å•çš„ **ç”¨æˆ·å’Œäº§å“ç®¡ç†ç³»ç»Ÿ**ï¼Œæ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€äº§å“ç®¡ç†ç­‰åŠŸèƒ½ã€‚æˆ‘ä»¬å°†ä»éœ€æ±‚åˆ†æå¼€å§‹ï¼Œé€æ­¥å®Œæˆæ•°æ®åº“è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½å®ç°ã€æµ‹è¯•ç”¨ä¾‹ç¼–å†™ä»¥åŠéƒ¨ç½²ä¸Šçº¿ã€‚

---

### **12.1 é¡¹ç›®éœ€æ±‚åˆ†æ**

#### **12.1.1 åŠŸèƒ½éœ€æ±‚**
1. **ç”¨æˆ·ç®¡ç†**ï¼š
   - ç”¨æˆ·æ³¨å†Œã€‚
   - ç”¨æˆ·ç™»å½•ï¼ˆä½¿ç”¨ JWT è®¤è¯ï¼‰ã€‚
   - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚
   - ç”¨æˆ·æ³¨é”€ã€‚

2. **äº§å“ç®¡ç†**ï¼š
   - æ·»åŠ æ–°äº§å“ã€‚
   - è·å–äº§å“åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œè¿‡æ»¤ï¼‰ã€‚
   - è·å–å•ä¸ªäº§å“è¯¦æƒ…ã€‚
   - æ›´æ–°äº§å“ä¿¡æ¯ã€‚
   - åˆ é™¤äº§å“ã€‚

#### **12.1.2 éåŠŸèƒ½éœ€æ±‚**
1. **å®‰å…¨æ€§**ï¼š
   - ä½¿ç”¨ JWT è¿›è¡Œç”¨æˆ·è®¤è¯ã€‚
   - å¯†ç åŠ å¯†å­˜å‚¨ã€‚

2. **æ€§èƒ½**ï¼š
   - ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–é¢‘ç¹è®¿é—®çš„æ•°æ®ã€‚
   - ä½¿ç”¨åˆ†é¡µå‡å°‘å•æ¬¡è¯·æ±‚çš„æ•°æ®é‡ã€‚

3. **å¯ç»´æŠ¤æ€§**ï¼š
   - ä½¿ç”¨ Flask-RESTful ç»„ç»‡ä»£ç ã€‚
   - ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

---

### **12.2 è®¾è®¡æ•°æ®åº“æ¨¡å‹**

#### **12.2.1 ç”¨æˆ·è¡¨ï¼ˆUserï¼‰**
| å­—æ®µå     | ç±»å‹         | æè¿°           |
|------------|--------------|----------------|
| id         | Integer      | ä¸»é”®           |
| username   | String(50)   | ç”¨æˆ·åï¼Œå”¯ä¸€   |
| password   | String(100)  | å¯†ç ï¼ˆåŠ å¯†ï¼‰   |
| email      | String(100)  | é‚®ç®±ï¼Œå”¯ä¸€     |

#### **12.2.2 äº§å“è¡¨ï¼ˆProductï¼‰**
| å­—æ®µå     | ç±»å‹         | æè¿°           |
|------------|--------------|----------------|
| id         | Integer      | ä¸»é”®           |
| name       | String(100)  | äº§å“åç§°       |
| price      | Float        | äº§å“ä»·æ ¼       |
| user_id    | Integer      | å¤–é”®ï¼Œå…³è”ç”¨æˆ· |

#### **12.2.3 æ•°æ®åº“æ¨¡å‹ä»£ç **
```python
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    password = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)
    products = db.relationship('Product', backref='user', lazy=True)

class Product(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    price = db.Column(db.Float, nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
```

---

### **12.3 å®ç°æ ¸å¿ƒåŠŸèƒ½**

#### **12.3.1 ç”¨æˆ·ç®¡ç†**
- **ç”¨æˆ·æ³¨å†Œ**ï¼š
  ```python
  @app.route('/register', methods=['POST'])
  def register():
      data = request.get_json()
      username = data.get('username')
      password = data.get('password')
      email = data.get('email')

      if User.query.filter_by(username=username).first():
          return jsonify({'message': 'Username already exists'}), 400

      new_user = User(username=username, password=password, email=email)
      db.session.add(new_user)
      db.session.commit()

      return jsonify({'message': 'User registered successfully'}), 201
  ```

- **ç”¨æˆ·ç™»å½•**ï¼š
  ```python
  @app.route('/login', methods=['POST'])
  def login():
      data = request.get_json()
      username = data.get('username')
      password = data.get('password')

      user = User.query.filter_by(username=username).first()
      if user and user.password == password:
          access_token = create_access_token(identity=username)
          return jsonify(access_token=access_token), 200
      else:
          return jsonify({'message': 'Invalid credentials'}), 401
  ```

#### **12.3.2 äº§å“ç®¡ç†**
- **æ·»åŠ äº§å“**ï¼š
  ```python
  @app.route('/products', methods=['POST'])
  @jwt_required()
  def add_product():
      current_user = get_jwt_identity()
      user = User.query.filter_by(username=current_user).first()

      data = request.get_json()
      name = data.get('name')
      price = data.get('price')

      new_product = Product(name=name, price=price, user_id=user.id)
      db.session.add(new_product)
      db.session.commit()

      return jsonify({'message': 'Product added successfully'}), 201
  ```

- **è·å–äº§å“åˆ—è¡¨**ï¼š
  ```python
  @app.route('/products', methods=['GET'])
  def get_products():
      page = request.args.get('page', 1, type=int)
      per_page = request.args.get('per_page', 10, type=int)
      products = Product.query.paginate(page=page, per_page=per_page)
      return jsonify({
          'products': [{'id': p.id, 'name': p.name, 'price': p.price} for p in products.items],
          'total_pages': products.pages,
          'current_page': products.page
      })
  ```

---

### **12.4 ç¼–å†™æµ‹è¯•ç”¨ä¾‹**

#### **12.4.1 å®‰è£…æµ‹è¯•å·¥å…·**
```bash
pip install pytest Flask-Testing
```

#### **12.4.2 ç¼–å†™å•å…ƒæµ‹è¯•**
- **æµ‹è¯•ç”¨æˆ·æ³¨å†Œ**ï¼š
  ```python
  def test_register(self):
      response = self.app.post('/register', json={
          'username': 'Alice',
          'password': 'password',
          'email': 'alice@example.com'
      })
      self.assertEqual(response.status_code, 201)
      self.assertIn('User registered successfully', response.get_data(as_text=True))
  ```

- **æµ‹è¯•ç”¨æˆ·ç™»å½•**ï¼š
  ```python
  def test_login(self):
      self.app.post('/register', json={
          'username': 'Alice',
          'password': 'password',
          'email': 'alice@example.com'
      })
      response = self.app.post('/login', json={
          'username': 'Alice',
          'password': 'password'
      })
      self.assertEqual(response.status_code, 200)
      self.assertIn('access_token', response.get_data(as_text=True))
  ```

---

### **12.5 éƒ¨ç½²ä¸Šçº¿**

#### **12.5.1 ä½¿ç”¨ Gunicorn éƒ¨ç½²**
```bash
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

#### **12.5.2 ä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†**
1. é…ç½® Nginxï¼š
   ```nginx
   server {
       listen 80;
       server_name your_domain.com;

       location / {
           proxy_pass http://127.0.0.1:8000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

2. é‡å¯ Nginxï¼š
   ```bash
   sudo systemctl restart nginx
   ```

#### **12.5.3 ä½¿ç”¨ Docker éƒ¨ç½²**
1. æ„å»º Docker é•œåƒï¼š
   ```bash
   docker build -t my-flask-app .
   ```

2. è¿è¡Œ Docker å®¹å™¨ï¼š
   ```bash
   docker run -d -p 5000:5000 my-flask-app
   ```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»å®Œæˆäº†ä¸€ä¸ªå®Œæ•´çš„ Flask é¡¹ç›®ï¼ŒåŒ…æ‹¬éœ€æ±‚åˆ†æã€æ•°æ®åº“è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½å®ç°ã€æµ‹è¯•ç”¨ä¾‹ç¼–å†™ä»¥åŠéƒ¨ç½²ä¸Šçº¿ã€‚å¸Œæœ›è¿™ä¸ªå®æˆ˜é¡¹ç›®èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Flask å’Œ RESTful API çš„å¼€å‘æµç¨‹ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
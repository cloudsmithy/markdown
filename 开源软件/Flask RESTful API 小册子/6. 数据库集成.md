## **6. æ•°æ®åº“é›†æˆ**

åœ¨æ„å»º RESTful API æ—¶ï¼Œæ•°æ®åº“æ˜¯å­˜å‚¨å’Œç®¡ç†æ•°æ®çš„æ ¸å¿ƒç»„ä»¶ã€‚Flask é€šè¿‡ **Flask-SQLAlchemy** æ‰©å±•åº“æä¾›äº†å¼ºå¤§çš„æ•°æ®åº“æ”¯æŒã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Flask-SQLAlchemy è¿›è¡Œæ•°æ®åº“æ“ä½œï¼ŒåŒ…æ‹¬å®šä¹‰æ¨¡å‹ç±»ã€æ•°æ®åº“è¿ç§»ä»¥åŠå®ç° CRUDï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰æ“ä½œã€‚

---

### **6.1 ä½¿ç”¨ Flask-SQLAlchemy è¿›è¡Œæ•°æ®åº“æ“ä½œ**

#### **6.1.1 ä»€ä¹ˆæ˜¯ Flask-SQLAlchemyï¼Ÿ**
Flask-SQLAlchemy æ˜¯ä¸€ä¸ª Flask æ‰©å±•åº“ï¼Œé›†æˆäº† SQLAlchemyï¼ˆä¸€ä¸ªæµè¡Œçš„ Python ORM åº“ï¼‰ã€‚å®ƒç®€åŒ–äº†æ•°æ®åº“æ“ä½œï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ï¼ˆå¦‚ SQLiteã€MySQLã€PostgreSQLï¼‰ã€‚

#### **6.1.2 å®‰è£… Flask-SQLAlchemy**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flask-SQLAlchemyï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install Flask-SQLAlchemy
```

#### **6.1.3 é…ç½®æ•°æ®åº“**
åœ¨ `app.py` ä¸­é…ç½®æ•°æ®åº“è¿æ¥ï¼š
```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)

# é…ç½®æ•°æ®åº“è¿æ¥
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///mydatabase.db'  # SQLite æ•°æ®åº“
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False  # ç¦ç”¨äº‹ä»¶ç³»ç»Ÿï¼Œé¿å…æ€§èƒ½æŸè€—

# åˆ›å»º SQLAlchemy å®ä¾‹
db = SQLAlchemy(app)
```

- **SQLALCHEMY_DATABASE_URI**ï¼šæŒ‡å®šæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚
  - SQLiteï¼š`sqlite:///mydatabase.db`
  - MySQLï¼š`mysql://username:password@host/dbname`
  - PostgreSQLï¼š`postgresql://username:password@host/dbname`
- **SQLALCHEMY_TRACK_MODIFICATIONS**ï¼šç¦ç”¨äº‹ä»¶ç³»ç»Ÿï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚

---

### **6.2 å®šä¹‰æ¨¡å‹ç±»**

#### **6.2.1 ä»€ä¹ˆæ˜¯æ¨¡å‹ç±»ï¼Ÿ**
æ¨¡å‹ç±»æ˜¯æ•°æ®åº“è¡¨çš„ Python è¡¨ç¤ºã€‚æ¯ä¸ªæ¨¡å‹ç±»å¯¹åº”ä¸€å¼ è¡¨ï¼Œç±»çš„å±æ€§å¯¹åº”è¡¨çš„å­—æ®µã€‚

#### **6.2.2 å®šä¹‰ç”¨æˆ·æ¨¡å‹ç±»**
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨æˆ·æ¨¡å‹ç±»çš„ç¤ºä¾‹ï¼š
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)  # ä¸»é”®
    username = db.Column(db.String(50), unique=True, nullable=False)  # ç”¨æˆ·åï¼Œå”¯ä¸€ä¸”éç©º
    email = db.Column(db.String(100), unique=True, nullable=False)  # é‚®ç®±ï¼Œå”¯ä¸€ä¸”éç©º

    def __repr__(self):
        return f'<User {self.username}>'
```

- **å­—æ®µç±»å‹**ï¼š
  - `db.Integer`ï¼šæ•´æ•°å­—æ®µã€‚
  - `db.String`ï¼šå­—ç¬¦ä¸²å­—æ®µã€‚
  - `db.Boolean`ï¼šå¸ƒå°”å­—æ®µã€‚
  - `db.DateTime`ï¼šæ—¥æœŸæ—¶é—´å­—æ®µã€‚

- **å­—æ®µå‚æ•°**ï¼š
  - `primary_key`ï¼šæ˜¯å¦ä¸ºä¸»é”®ã€‚
  - `unique`ï¼šæ˜¯å¦å”¯ä¸€ã€‚
  - `nullable`ï¼šæ˜¯å¦å…è®¸ä¸ºç©ºã€‚

#### **6.2.3 åˆ›å»ºæ•°æ®åº“è¡¨**
åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ•°æ®åº“è¡¨ï¼š
```bash
flask shell
>>> from app import db
>>> db.create_all()
```

è¿™ä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª SQLite æ•°æ®åº“æ–‡ä»¶ `mydatabase.db`ï¼Œå¹¶åˆ›å»º `User` è¡¨ã€‚

---

### **6.3 æ•°æ®åº“è¿ç§»ï¼ˆFlask-Migrateï¼‰**

#### **6.3.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿ç§»ï¼Ÿ**
æ•°æ®åº“è¿ç§»æ˜¯ç®¡ç†æ•°æ®åº“ schema å˜æ›´çš„å·¥å…·ã€‚é€šè¿‡è¿ç§»ï¼Œå¯ä»¥è½»æ¾åœ°æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è¡¨æˆ–å­—æ®µï¼Œè€Œä¸ä¼šä¸¢å¤±ç°æœ‰æ•°æ®ã€‚

#### **6.3.2 å®‰è£… Flask-Migrate**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flask-Migrateï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install Flask-Migrate
```

#### **6.3.3 é…ç½® Flask-Migrate**
åœ¨ `app.py` ä¸­é…ç½® Flask-Migrateï¼š
```python
from flask_migrate import Migrate

# åˆå§‹åŒ– Flask-Migrate
migrate = Migrate(app, db)
```

#### **6.3.4 ä½¿ç”¨ Flask-Migrate**
1. **åˆå§‹åŒ–è¿ç§»ä»“åº“**ï¼š
   ```bash
   flask db init
   ```
   è¿™ä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª `migrations` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨è¿ç§»è„šæœ¬ã€‚

2. **ç”Ÿæˆè¿ç§»è„šæœ¬**ï¼š
   ```bash
   flask db migrate -m "Initial migration"
   ```
   è¿™ä¼šæ ¹æ®æ¨¡å‹ç±»çš„å˜åŒ–ç”Ÿæˆè¿ç§»è„šæœ¬ã€‚

3. **åº”ç”¨è¿ç§»**ï¼š
   ```bash
   flask db upgrade
   ```
   è¿™ä¼šå°†è¿ç§»è„šæœ¬åº”ç”¨åˆ°æ•°æ®åº“ã€‚

4. **å›æ»šè¿ç§»**ï¼š
   ```bash
   flask db downgrade
   ```
   è¿™ä¼šæ’¤é”€ä¸Šä¸€æ¬¡è¿ç§»ã€‚

---

### **6.4 å®ç° CRUD æ“ä½œ**

#### **6.4.1 åˆ›å»ºï¼ˆCreateï¼‰**
- **æ·»åŠ æ–°ç”¨æˆ·**ï¼š
  ```python
  new_user = User(username='Alice', email='alice@example.com')
  db.session.add(new_user)
  db.session.commit()
  ```

#### **6.4.2 è¯»å–ï¼ˆReadï¼‰**
- **è·å–æ‰€æœ‰ç”¨æˆ·**ï¼š
  ```python
  users = User.query.all()
  ```

- **è·å–å•ä¸ªç”¨æˆ·**ï¼š
  ```python
  user = User.query.get(1)  # è·å– ID ä¸º 1 çš„ç”¨æˆ·
  ```

- **æ¡ä»¶æŸ¥è¯¢**ï¼š
  ```python
  user = User.query.filter_by(username='Alice').first()
  ```

#### **6.4.3 æ›´æ–°ï¼ˆUpdateï¼‰**
- **æ›´æ–°ç”¨æˆ·ä¿¡æ¯**ï¼š
  ```python
  user = User.query.get(1)
  user.email = 'new_email@example.com'
  db.session.commit()
  ```

#### **6.4.4 åˆ é™¤ï¼ˆDeleteï¼‰**
- **åˆ é™¤ç”¨æˆ·**ï¼š
  ```python
  user = User.query.get(1)
  db.session.delete(user)
  db.session.commit()
  ```

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆæ•°æ®åº“æ“ä½œçš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///mydatabase.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
migrate = Migrate(app, db)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)

    def __repr__(self):
        return f'<User {self.username}>'

@app.route('/users', methods=['POST'])
def create_user():
    data = request.get_json()
    new_user = User(username=data['username'], email=data['email'])
    db.session.add(new_user)
    db.session.commit()
    return jsonify({'id': new_user.id, 'username': new_user.username, 'email': new_user.email}), 201

@app.route('/users/<int:user_id>', methods=['GET'])
def get_user(user_id):
    user = User.query.get_or_404(user_id)
    return jsonify({'id': user.id, 'username': user.username, 'email': user.email})

@app.route('/users/<int:user_id>', methods=['PUT'])
def update_user(user_id):
    user = User.query.get_or_404(user_id)
    data = request.get_json()
    user.username = data.get('username', user.username)
    user.email = data.get('email', user.email)
    db.session.commit()
    return jsonify({'id': user.id, 'username': user.username, 'email': user.email})

@app.route('/users/<int:user_id>', methods=['DELETE'])
def delete_user(user_id):
    user = User.query.get_or_404(user_id)
    db.session.delete(user)
    db.session.commit()
    return '', 204

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•ä½¿ç”¨ Flask-SQLAlchemy è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚
2. å¦‚ä½•å®šä¹‰æ¨¡å‹ç±»å¹¶åˆ›å»ºæ•°æ®åº“è¡¨ã€‚
3. å¦‚ä½•ä½¿ç”¨ Flask-Migrate è¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚
4. å¦‚ä½•å®ç° CRUD æ“ä½œã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **7. ç”¨æˆ·è®¤è¯ä¸æˆæƒ**ï¼Œå­¦ä¹ å¦‚ä½•ä½¿ç”¨ Flask-JWT-Extended å®ç° JWT è®¤è¯ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„
## **9. é«˜çº§åŠŸèƒ½**

åœ¨æ„å»º RESTful API æ—¶ï¼Œé™¤äº†åŸºç¡€åŠŸèƒ½å¤–ï¼Œè¿˜éœ€è¦å®ç°ä¸€äº›é«˜çº§åŠŸèƒ½æ¥æå‡ç³»ç»Ÿçš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°åˆ†é¡µä¸è¿‡æ»¤ã€ç¼“å­˜ã€æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨ä»¥åŠå¼‚æ­¥ä»»åŠ¡ã€‚

---

### **9.1 åˆ†é¡µä¸è¿‡æ»¤**

#### **9.1.1 åˆ†é¡µ**
åˆ†é¡µæ˜¯å°†å¤§é‡æ•°æ®æ‹†åˆ†ä¸ºå¤šä¸ªå°å—è¿”å›ï¼Œä»¥å‡å°‘å•æ¬¡è¯·æ±‚çš„æ•°æ®é‡ã€‚

- **ç¤ºä¾‹ï¼šå®ç°åˆ†é¡µ**
  ```python
  from flask import request

  @app.route('/users', methods=['GET'])
  def get_users():
      page = request.args.get('page', 1, type=int)
      per_page = request.args.get('per_page', 10, type=int)
      users = User.query.paginate(page=page, per_page=per_page)
      return jsonify({
          'users': [user.username for user in users.items],
          'total_pages': users.pages,
          'current_page': users.page
      })
  ```

- **paginate**ï¼šåˆ†é¡µæŸ¥è¯¢ï¼Œè¿”å›ä¸€ä¸ª `Pagination` å¯¹è±¡ã€‚
- **items**ï¼šå½“å‰é¡µçš„æ•°æ®ã€‚
- **pages**ï¼šæ€»é¡µæ•°ã€‚
- **page**ï¼šå½“å‰é¡µç ã€‚

#### **9.1.2 è¿‡æ»¤**
è¿‡æ»¤æ˜¯æ ¹æ®æ¡ä»¶ç­›é€‰æ•°æ®ã€‚

- **ç¤ºä¾‹ï¼šå®ç°è¿‡æ»¤**
  ```python
  @app.route('/users', methods=['GET'])
  def get_users():
      username = request.args.get('username')
      query = User.query
      if username:
          query = query.filter(User.username.contains(username))
      users = query.all()
      return jsonify([user.username for user in users])
  ```

- **filter**ï¼šæ ¹æ®æ¡ä»¶ç­›é€‰æ•°æ®ã€‚
- **contains**ï¼šæ¨¡ç³ŠåŒ¹é…ã€‚

---

### **9.2 ç¼“å­˜ï¼ˆFlask-Cachingï¼‰**

#### **9.2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ**
ç¼“å­˜æ˜¯å°†é¢‘ç¹è®¿é—®çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä»¥å‡å°‘æ•°æ®åº“æŸ¥è¯¢æˆ–è®¡ç®—çš„å¼€é”€ã€‚

#### **9.2.2 å®‰è£… Flask-Caching**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Flask-Cachingï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install Flask-Caching
```

#### **9.2.3 é…ç½®ç¼“å­˜**
åœ¨ `app.py` ä¸­é…ç½®ç¼“å­˜ï¼š
```python
from flask_caching import Cache

app.config['CACHE_TYPE'] = 'SimpleCache'  # ä½¿ç”¨ç®€å•ç¼“å­˜
app.config['CACHE_DEFAULT_TIMEOUT'] = 300  # ç¼“å­˜é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰

cache = Cache(app)
```

#### **9.2.4 ä½¿ç”¨ç¼“å­˜**
- **ç¼“å­˜è§†å›¾å‡½æ•°**ï¼š
  ```python
  @app.route('/cached')
  @cache.cached(timeout=60)  # ç¼“å­˜ 60 ç§’
  def cached():
      return 'This response is cached'
  ```

- **ç¼“å­˜æ•°æ®**ï¼š
  ```python
  @app.route('/users', methods=['GET'])
  def get_users():
      users = cache.get('users')
      if users is None:
          users = [user.username for user in User.query.all()]
          cache.set('users', users, timeout=60)
      return jsonify(users)
  ```

---

### **9.3 æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨**

#### **9.3.1 æ–‡ä»¶ä¸Šä¼ **
Flask æä¾›äº† `request.files` æ¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ã€‚

- **ç¤ºä¾‹ï¼šæ–‡ä»¶ä¸Šä¼ **
  ```python
  from werkzeug.utils import secure_filename

  @app.route('/upload', methods=['POST'])
  def upload_file():
      file = request.files['file']
      if file:
          filename = secure_filename(file.filename)
          file.save(f'uploads/{filename}')
          return jsonify({'message': 'File uploaded successfully'}), 201
      else:
          return jsonify({'message': 'No file uploaded'}), 400
  ```

- **secure_filename**ï¼šç¡®ä¿æ–‡ä»¶åå®‰å…¨ã€‚
- **save**ï¼šä¿å­˜æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„ã€‚

#### **9.3.2 æ–‡ä»¶å­˜å‚¨**
å¯ä»¥å°†æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæˆ–äº‘å­˜å‚¨ï¼ˆå¦‚ Amazon S3ï¼‰ã€‚

- **ç¤ºä¾‹ï¼šä½¿ç”¨ Flask-S3 å­˜å‚¨æ–‡ä»¶**
  ```python
  from flask_s3 import FlaskS3

  app.config['FLASKS3_BUCKET_NAME'] = 'your-bucket-name'
  s3 = FlaskS3(app)

  @app.route('/upload', methods=['POST'])
  def upload_file():
      file = request.files['file']
      if file:
          filename = secure_filename(file.filename)
          s3.save_file(file, filename)
          return jsonify({'message': 'File uploaded to S3 successfully'}), 201
      else:
          return jsonify({'message': 'No file uploaded'}), 400
  ```

---

### **9.4 å¼‚æ­¥ä»»åŠ¡ï¼ˆCeleryï¼‰**

#### **9.4.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Ÿ**
å¼‚æ­¥ä»»åŠ¡æ˜¯æŒ‡å°†è€—æ—¶æ“ä½œï¼ˆå¦‚å‘é€é‚®ä»¶ã€å¤„ç†æ–‡ä»¶ï¼‰æ”¾åˆ°åå°æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

#### **9.4.2 å®‰è£… Celery**
å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Celeryï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install celery
```

#### **9.4.3 é…ç½® Celery**
åœ¨ `app.py` ä¸­é…ç½® Celeryï¼š
```python
from celery import Celery

app.config['CELERY_BROKER_URL'] = 'redis://localhost:6379/0'
app.config['CELERY_RESULT_BACKEND'] = 'redis://localhost:6379/0'

celery = Celery(app.name, broker=app.config['CELERY_BROKER_URL'])
celery.conf.update(app.config)
```

#### **9.4.4 å®šä¹‰å¼‚æ­¥ä»»åŠ¡**
- **ç¤ºä¾‹ï¼šå‘é€é‚®ä»¶ä»»åŠ¡**
  ```python
  @celery.task
  def send_email(email, message):
      # æ¨¡æ‹Ÿå‘é€é‚®ä»¶
      import time
      time.sleep(5)
      print(f'Email sent to {email}: {message}')
  ```

#### **9.4.5 è°ƒç”¨å¼‚æ­¥ä»»åŠ¡**
åœ¨è§†å›¾å‡½æ•°ä¸­è°ƒç”¨å¼‚æ­¥ä»»åŠ¡ï¼š
```python
@app.route('/send-email', methods=['POST'])
def send_email_route():
    data = request.get_json()
    email = data.get('email')
    message = data.get('message')
    send_email.delay(email, message)  # å¼‚æ­¥è°ƒç”¨
    return jsonify({'message': 'Email is being sent'}), 202
```

---

## **å®Œæ•´ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“åˆåˆ†é¡µã€ç¼“å­˜ã€æ–‡ä»¶ä¸Šä¼ å’Œå¼‚æ­¥ä»»åŠ¡çš„å®Œæ•´ç¤ºä¾‹ï¼š
```python
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_caching import Cache
from celery import Celery
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///mydatabase.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['CACHE_TYPE'] = 'SimpleCache'
app.config['CACHE_DEFAULT_TIMEOUT'] = 300
app.config['CELERY_BROKER_URL'] = 'redis://localhost:6379/0'
app.config['CELERY_RESULT_BACKEND'] = 'redis://localhost:6379/0'

db = SQLAlchemy(app)
cache = Cache(app)
celery = Celery(app.name, broker=app.config['CELERY_BROKER_URL'])
celery.conf.update(app.config)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)

@app.route('/users', methods=['GET'])
def get_users():
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 10, type=int)
    users = User.query.paginate(page=page, per_page=per_page)
    return jsonify({
        'users': [user.username for user in users.items],
        'total_pages': users.pages,
        'current_page': users.page
    })

@app.route('/upload', methods=['POST'])
def upload_file():
    file = request.files['file']
    if file:
        filename = secure_filename(file.filename)
        file.save(f'uploads/{filename}')
        return jsonify({'message': 'File uploaded successfully'}), 201
    else:
        return jsonify({'message': 'No file uploaded'}), 400

@celery.task
def send_email(email, message):
    import time
    time.sleep(5)
    print(f'Email sent to {email}: {message}')

@app.route('/send-email', methods=['POST'])
def send_email_route():
    data = request.get_json()
    email = data.get('email')
    message = data.get('message')
    send_email.delay(email, message)
    return jsonify({'message': 'Email is being sent'}), 202

if __name__ == '__main__':
    app.run(debug=True)
```

---

## **æ€»ç»“**
é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ä»¥ä¸‹å†…å®¹ï¼š
1. å¦‚ä½•å®ç°åˆ†é¡µä¸è¿‡æ»¤ã€‚
2. å¦‚ä½•ä½¿ç”¨ Flask-Caching è¿›è¡Œç¼“å­˜ã€‚
3. å¦‚ä½•å¤„ç†æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨ã€‚
4. å¦‚ä½•ä½¿ç”¨ Celery å®ç°å¼‚æ­¥ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥ **10. API æ–‡æ¡£ä¸æµ‹è¯•**ï¼Œå­¦ä¹ å¦‚ä½•ç”Ÿæˆ API æ–‡æ¡£å’Œç¼–å†™æµ‹è¯•ç”¨ä¾‹ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„è§£é‡Šå’Œä»£ç ç¤ºä¾‹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼ ğŸ˜„